<?xml version="1.0"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
"http://hibernate.sourceforge.net/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <class name="com.graffitab.server.persistence.model.User" table="gt_user">
        <id name="id" type="java.lang.Long">
            <column name="id" />
            <generator class="native" />
        </id>
        <property name="guid" column="guid" not-null="false"/>
        <property name="username" column="username" not-null="true" />
        <property name="password" column="password" not-null="true"/>
        <property name="firstName" column="firstname" not-null="true"/>
        <property name="lastName" column="lastname" not-null="true"/>
        <property name="email" column="email" not-null="true"/>
        <property name="website" column="website" not-null="false"/>
        <property name="about" column="about" not-null="false"/>

		<property name="accountStatus" column="status">
            <type name="org.hibernate.type.EnumType">
                <param name="enumClass">com.graffitab.server.persistence.model.User$AccountStatus</param>
                <param name="type">12</param>
            </type>
        </property>

        <!--  http://viralpatel.net/blogs/hibernate-many-to-many-xml-mapping-example/ -->
        <set name="followers" cascade="all" table="following">
            <key column="following_id" not-null="true" />
        	<many-to-many class="com.graffitab.server.persistence.model.User">
        		<column name="user_id" not-null="true" />
        	</many-to-many>
        </set>

        <set name="following" cascade="all" table="following">
            <key column="user_id" not-null="true" />
        	<many-to-many class="com.graffitab.server.persistence.model.User">
        	   <column name="following_id" not-null="true" />
        	</many-to-many>
        </set>

		<!-- Bidirectional mapping -->
        <list name="assets" cascade="all" table="asset">
            <key column="user_id" not-null="true" />
            <list-index column="order_key" />
        	<one-to-many class="com.graffitab.server.persistence.model.Asset" />
        </list>

		<map name="metadataItems" table="gt_user_metadata" cascade="all">
            <key column="user_id"/>
            <map-key column="metadata_key" type="string"/>
            <element column="metadata_value" type="string"/>
        </map>

     </class>

     <query name="User.findAll">
       select u
       from User u
     </query>

     <query name="User.findUsersWithEmail">
       select u
       from User u
       where u.email = :email
       and u.id != :userId
     </query>

     <query name="User.findUsersWithUsername">
       select u
       from User u
       where u.username = :username
       and u.id != :userId
     </query>

	<query name="User.findUsersWithMetadataValues">
       select u
       from User u
       join u.metadataItems mi
       where index(mi) = :metadataKey
       and :metadataValue in elements(mi)
     </query>

</hibernate-mapping>
